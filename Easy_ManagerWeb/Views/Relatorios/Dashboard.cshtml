@model IEnumerable<Easy_ManagerWeb.Models.Entrega>

@{
    ViewData["Title"] = "Dashboard | Relatórios";
    var statusLabels = ViewBag.StatusLabels as List<string>;
    var statusData = ViewBag.StatusData as List<int>;
}

<h2 class="mb-4">Dashboard Gerencial</h2>


<div class="row mb-5">

    <div class="col-md-4 mb-3">
        <div class="card text-white bg-primary shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-uppercase mb-0">Total de Entregas</h6>
                        <h1 class="display-4">@ViewBag.TotalEntregas</h1>
                    </div>
                    <i class="bi bi-truck display-4 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card text-white bg-success shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-uppercase mb-0">Total Faturado</h6>
                        <h1 class="display-4">@(((double)ViewBag.TotalFaturado).ToString("C"))</h1>
                    </div>
                    <i class="bi bi-cash-stack display-4 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card text-white bg-info shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-uppercase mb-0">Orçamento Médio</h6>
                        <h1 class="display-4">@(((double)ViewBag.OrcamentoMedio).ToString("C"))</h1>
                    </div>
                    <i class="bi bi-calculator display-4 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-5">

    <div class="col-md-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-light">Entregas por Status</div>
            <div class="card-body d-flex justify-content-center">
                <canvas id="chartStatus" style="max-height: 350px;"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-light">Top 5 Clientes por Volume</div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    @if (ViewBag.TopClientes != null)
                    {
                        @foreach (var clienteData in ViewBag.TopClientes)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                @clienteData.ClienteNome
                                <span class="badge bg-primary rounded-pill">@clienteData.TotalEntregas entregas</span>
                            </li>
                        }
                    }
                    else
                    {
                        <li class="list-group-item text-muted">Nenhum cliente encontrado.</li>
                    }
                </ul>
            </div>
        </div>
    </div>
</div>


<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-light">Últimas 10 Entregas Registradas</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Pacote</th>
                                <th>Orçamento</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var entrega in Model)
                            {
                                <tr>
                                    <td>@entrega.Id</td>
                                    <td>@entrega.Cliente?.Nome</td>
                                    <td>
                                        @(string.Join(", ", entrega.Pacotes?.Select(p => p.Tamanho) ?? new List<string>()))
                                    </td>

                                    <td>@entrega.Orcamento?.ToString("C")</td>
                                    <td>
                                        <span class="badge @(entrega.Status == "Entregue" ? "bg-success" : entrega.Status == "Em Rota" ? "bg-warning text-dark" : "bg-secondary")">
                                            @entrega.Status
                                        </span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // Dados para o gráfico de Entregas por Status
            var statusLabels = @Html.Raw(Json.Serialize(statusLabels));
            var statusData = @Html.Raw(Json.Serialize(statusData));

            var ctxStatus = document.getElementById('chartStatus').getContext('2d');

            // Cores para o gráfico
            var chartColors = [
                '#0d6efd', // Primary
                '#198754', // Success
                '#ffc107', // Warning
                '#dc3545', // Danger
                '#6c757d'  // Secondary
            ];

            new Chart(ctxStatus, {
                type: 'doughnut', // Gráfico de Rosca
                data: {
                    labels: statusLabels,
                    datasets: [{
                        data: statusData,
                        backgroundColor: chartColors.slice(0, statusLabels.length),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: false,
                        }
                    }
                }
            });
        });
    </script>
}